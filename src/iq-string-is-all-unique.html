<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-collapse-item/paper-collapse-item.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="iq-code-editor.html">
<link rel="import" href="iq-test-results.html">

<dom-module id="iq-string-is-all-unique">
    <template>
        <style include="shared-styles">
             :host {
                display: block;
                padding: 10px;
            }
        </style>

        <div class="card">
            <h2>String With All Unique Characters</h2>
            <p>
                Write a function to determine if all characters in a string are unique.
            </p>
            <iq-code-editor
                id="userLandCode"
                content="function areAllCharactersUnique(theString) {}"
            ></iq-code-editor>
            <iq-test-results test-results={{userlandSolutionTestResults}}></iq-test-results>
        </div>
        <div class="card">
            <paper-collapse-item header="Example Solution" id="exampleSolutionCollapse" opened="true">
                <iq-code-editor 
                    id="exampleSolutionCode"
                    content="[[exampleSolution]]">
                </iq-code-editor>
                <iq-test-results test-results="{{testResults}}"></iq-test-results>
            </paper-collapse-item>
        </div>
    </template>
    <script>
        class StringIsAllUnique extends Polymer.Element {
            static get is() { return 'iq-string-is-all-unique'; }

            static get properties() {
                return {
                    testResults: {
                        type: Array,
                        value() {
                            return []
                        }
                    },
                    exampleSolution: {
                        type: String,
                        computed: 'computeExampleSolution()'
                    },
                    userlandSolutionTestResults: {
                        type: Array,
                        value() {
                            return []
                        }
                    }
                }
            }

            connectedCallback() {
                super.connectedCallback();
                this.shadowRoot.querySelector('#userLandCode').addEventListener('checkCode', e => this.checkCode(e));
                this.shadowRoot.querySelector('#exampleSolutionCollapse').opened = false;
                this.runTests(this.computeExampleSolution(), 'testResults');
            }

            checkCode(e) {
                this.runTests(e.detail.code, 'userlandSolutionTestResults');
            }

            computeExampleSolution() {
                return "function " + this.areAllCharactersUnique.toString();
            }

            /*
                Function to validate if all characters in a string are unique.
                Returns true if all characters are unique.
                Returns false if there are duplicate characters or bad input.
            */
            areAllCharactersUnique(theString) {

                // validate input
                if(theString === '' || theString === undefined || theString === null) {
                    return false;    
                }

                // if the string contains just a single character we can return true and saving processing time
                if(theString.length == 1) {
                    return true;
                }

                // use a hashmap to count the number of each character in the string
                let charCount = new Map();

                // iterate through all characters in the string, adding them to the hashmap
                for(var i =0; i < theString.length; i++) {
                    let char = theString[i];

                    // check to see if this character has already been counted in the hashmap, if so the string does not contain all unique characters
                    if(charCount.get(char) != undefined) {
                        return false;
                    }

                    // add the char we checked to the hashmap, if we find another instance of this char in the loop we know the string isn't unique
                    charCount.set(char, 1);
                }

                return true;
            }

            runTests(fn, resultStoreName) {
                // clear the result store before we start running tests
                this.set(resultStoreName, []);

                // set of tests to validate if the function solves the problem
                this.evalTest(fn, "abcdefghijklmnop", 'All unique characters should return true.', true, resultStoreName);
                this.evalTest(fn, "a", 'Single character should return true.', true, resultStoreName);
                this.evalTest(fn, "abcddefg", 'String with duplicate character should return false.', false, resultStoreName);
                this.evalTest(fn, "bb", 'Two character string with duplicate characters should return false.', false, resultStoreName);
                this.evalTest(fn, "abc def ghikl", 'String with two spaces but no duplicate characters should return false.', false, resultStoreName);
                this.evalTest(fn, "", 'No value should return false.', false, resultStoreName);
                this.evalTest(fn, null, 'Null value should return false.', false, resultStoreName);
                this.evalTest(fn, undefined, 'undefined should return false.', false, resultStoreName);
            }

            evalTest(fn, param, name, expectedResult, resultStoreName) {
                // if the param type is a string, we need to wrap it in single quotes so it is passed as a string when the function is evaled
                if(typeof param === "string") {
                    param = "'" + param + "'";
                }

                // wrap the function string in an IIFE, passing in the param and then eval the string to execute the function
                let functionToExecute = "("+ fn + ")(" + param + ");";
                this.push(resultStoreName, {
                    success: eval(functionToExecute) === expectedResult,
                    name: name,
                    description: "Parameter value used: " + param
                });
            }
        }

        window.customElements.define(StringIsAllUnique.is, StringIsAllUnique);
    </script>
</dom-module>